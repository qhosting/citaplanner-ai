# [AURUM PROTOCOL] - DOCKERFILE MIRROR
# PRODUCTO: CITAPLANNER ELITE BUSINESS SUITE
# REVISIÓN: 2026.2
# STATUS: PRODUCTION READY (OPTIMIZADO PARA ES MODULES)

# --- FASE 1: BUILDER ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# Generación de Prisma Client (Opcional)
RUN if [ -f "./prisma/schema.prisma" ]; then npx prisma generate; fi

# Build del Frontend (Vite)
RUN npm run build

# --- FASE 2: RUNNER ---
FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000

# Seguridad: Usuario no-root
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 citaplanner

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/server.js ./
COPY --from=builder /app/package*.json ./

# Solo dependencias de producción
RUN npm install --omit=dev

RUN chown -R citaplanner:nodejs /app

USER citaplanner

EXPOSE 3000

CMD ["node", "server.js"]

# METADATA DE DESPLIEGUE:
# - Puerto: 3000 (Backend + Frontend Static)
# - Base de Datos: PostgreSQL (DATABASE_URL)
# - IA: Gemini (API_KEY)